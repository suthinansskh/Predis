<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predispensing Error Recorder</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Login Section -->
    <section id="login" class="login-section active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-pills"></i>
                    <h1>Predispensing Error Recorder</h1>
                    <p>กรุณาเข้าสู่ระบบด้วย PS Code/ID13 และรหัสผ่าน</p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="userCode">
                            <i class="fas fa-user"></i> PS Code หรือ ID13:
                        </label>
                        <input type="text" id="userCode" name="userCode" required 
                               placeholder="ใส่ PS Code หรือ ID13" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i> รหัสผ่าน:
                        </label>
                        <input type="password" id="password" name="password" required 
                               placeholder="ใส่รหัสผ่าน" autocomplete="current-password">
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ
                    </button>
                </form>
                
                <div class="login-info">
                    <p><i class="fas fa-info-circle"></i> ติดต่อ IT ถ้าไม่สามารถเข้าสู่ระบบได้</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Application (Initially Hidden) -->
    <div id="mainApp" class="container" style="display: none;">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-pills"></i> บันทึก Predispensing Error</h1>
                    <p>กรอกข้อมูลข้อผิดพลาดก่อนจ่ายยา</p>
                </div>
                <div class="header-right">
                    <span id="currentUser" class="current-user">
                        <i class="fas fa-user"></i> <span id="userName">Loading...</span>
                    </span>
                    <button id="logoutBtn" class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
                    </button>
                </div>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="showSection('form')">
                <i class="fas fa-plus"></i> บันทึกข้อผิดพลาด
            </button>
            <button class="nav-btn" onclick="showSection('dashboard')">
                <i class="fas fa-chart-bar"></i> แดชบอร์ด
            </button>
            <button class="nav-btn" onclick="showSection('druglist')">
                <i class="fas fa-pills"></i> รายการยา
            </button>
            <button class="nav-btn" onclick="showSection('settings')">
                <i class="fas fa-cog"></i> ตั้งค่า
            </button>
        </nav>

        <!-- Error Report Form Section -->
        <section id="form" class="section active">
            <div class="card">
                <h2>บันทึก Predispensing Error</h2>
                <form id="errorForm">
                    <div class="form-group">
                        <label for="eventDate">วันที่เกิดเหตุการณ์:</label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>

                    <input type="hidden" id="reportId" name="reportId">

                    <div class="form-group">
                        <label for="shift">เวร:</label>
                        <select id="shift" name="shift" required>
                            <option value="">เลือกเวร</option>
                            <option value="เช้า">เช้า (08:00-16:00)</option>
                            <option value="บ่าย">บ่าย (16:00-24:00)</option>
                            <option value="ดึก">ดึก (24:00-08:00)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="errorType">ประเภท:</label>
                        <select id="errorType" name="errorType" required>
                            <option value="">เลือกประเภท</option>
                            <option value="ผู้ป่วยนอก">ผู้ป่วยนอก</option>
                            <option value="ผู้ป่วยใน">ผู้ป่วยใน</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="location">สถานที่เกิดเหตุการณ์:</label>
                        <select id="location" name="location" required>
                            <option value="">เลือกสถานที่</option>
                            <option value="ห้องจ่ายยาผู้ป่วยนอกชั้น1">ห้องจ่ายยาผู้ป่วยนอกชั้น1</option>
                            <option value="ห้องจ่ายยาผู้ป่วยนอกชั้น2">ห้องจ่ายยาผู้ป่วยนอกชั้น2</option>
                            <option value="ห้องจ่ายยาจิตเวช">ห้องจ่ายยาจิตเวช</option>
                            <option value="ห้องจ่ายยาคลินคพิเศษ">ห้องจ่ายยาคลินคพิเศษ</option>
                            <option value="ห้องยาผู้ป่วยใน">ห้องยาผู้ป่วยใน</option>
                            <option value="ห้องยาอุบัติเหตุ-ฉุกเฉิน">ห้องยาอุบัติเหตุ-ฉุกเฉิน</option>
                            <option value="ห้องยาอุบัติเหตุ-ผู้ป่วยใน">ห้องยาอุบัติเหตุ-ผู้ป่วยใน</option>
                            <option value="ห้องยาอุบัติเหตุ-ผู้ป่วยกลับบ้าน">ห้องยาอุบัติเหตุ-ผู้ป่วยกลับบ้าน</option>
                            <option value="ห้องจ่ายเวชภัณฑ์">ห้องจ่ายเวชภัณฑ์</option>
                            <option value="งานจัดซื้อยาและเวชภัณฑ์">งานจัดซื้อยาและเวชภัณฑ์</option>
                            <option value="งานคลังยา">งานคลังยา</option>
                            <option value="งานผลิตยา">งานผลิตยา</option>
                            <option value="งานเคมีบำบัด">งานเคมีบำบัด</option>
                            <option value="คลังเวชภัณฑ์">งานคลังเวชภัณฑ์</option>
                            <option value="รพ.สต.">รพ.สต.</option>
                            <option value="อื่นๆ">อื่นๆ (ระบุในรายละเอียดเพิ่มเติม)</option>
                    </select>
                    </div>
                    <div class="form-group" id="substationGroup" style="display:none;">
                        <label for="substation">เลือกโรงพยาบาลส่งเสริมสุขภาพตำบล</label>
                        <select id="substation">
                            <option value="">เลือก รพ.สต.</option>
                            <option value="รพ.สต.คูซอด">รพ.สต.คูซอด</option>
                            <option value="รพ.สต.แทง">รพ.สต.แทง</option>
                            <option value="รพ.สต.หนองคู">รพ.สต.หนองคู</option>
                            <option value="รพ.สต.ตะดอบ">รพ.สต.ตะดอบ</option>
                            <option value="รพ.สต.หนองครก">รพ.สต.หนองครก</option>
                            <option value="รพ.สต.กุดโง้ง">รพ.สต.กุดโง้ง</option>
                            <option value="รพ.สต.โพนค้อ">รพ.สต.โพนค้อ</option>
                            <option value="รพ.สต.หนองแว้ง">รพ.สต.หนองแว้ง</option>
                            <option value="รพ.สต.โนนแกด">รพ.สต.โนนแกด</option>
                            <option value="รพ.สต.หนองไฮ">รพ.สต.หนองไฮ</option>
                            <option value="รพ.สต.หนองแก้ว">รพ.สต.หนองแก้ว</option>
                            <option value="รพ.สต.น้ำคำ">รพ.สต.น้ำคำ</option>
                            <option value="รพ.สต.หนองโน">รพ.สต.หนองโน</option>
                            <option value="รพ.สต.โพธิ์">รพ.สต.โพธิ์</option>
                            <option value="รพ.สต.ก้านเหลือง">รพ.สต.ก้านเหลือง</option>
                            <option value="รพ.สต.หนองไผ่">รพ.สต.หนองไผ่</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="process">กระบวนการ:</label>
                        <select id="process" name="process" required>
                            <option value="">เลือกกระบวนการ</option>
                            <option value="จัดยา">จัดยา</option>
                            <option value="ลงข้อมูล">ลงข้อมูล</option>
                            <option value="เตรียมยา">เตรียมยา</option>
                            <option value="คิดค่าใช้จ่าย">คิดค่าใช้จ่าย</option>
                            <option value="จัดเก็บ">จัดเก็บ</option>
                            <option value="จัดส่ง">จัดส่ง</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="errorDetail">ข้อผิดพลาด:</label>
                        <select id="errorDetail" name="errorDetail" required>
                            <option value="">เลือกข้อผิดพลาด</option>
                            <!-- จะถูก populate ตามกระบวนการที่เลือก -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="correctItem">รายการที่ถูกต้อง:</label>
                        <input type="text" id="correctItem" name="correctItem" 
                               list="correctItemList" 
                               placeholder="พิมพ์เพื่อค้นหารายการยาที่ถูกต้องตามใบสั่งยา" 
                               autocomplete="off" required>
                        <datalist id="correctItemList">
                        </datalist>
                        <small class="form-help">ค้นหาชื่อยาหรือรหัสยาที่ควรจะได้รับตามใบสั่งยา</small>
                    </div>

                    <div class="form-group">
                        <label for="incorrectItem">รายการยาที่ผิด: <span class="optional">(ไม่บังคับ)</span></label>
                        <input type="text" id="incorrectItem" name="incorrectItem" 
                               list="incorrectItemList" 
                               placeholder="พิมพ์เพื่อค้นหารายการยาที่เตรียมผิด (สามารถระบุค่าว่างได้)" 
                               autocomplete="off">
                        <datalist id="incorrectItemList">
                        </datalist>
                        <small class="form-help">กรณีไม่มียาที่เตรียมผิด หรือยังไม่ได้เตรียมยา สามารถปล่อยว่างได้</small>
                    </div>

                    <div class="form-group">
                        <label for="cause">สาเหตุ:</label>
                        <select id="cause" name="cause" required>
                            <option value="">เลือกสาเหตุ</option>
                            <option value="แคปซูลคล้ายกัน">แคปซูลคล้ายกัน</option>
                            <option value="เม็ดคล้ายกัน">เม็ดคล้ายกัน</option>
                            <option value="ชื่อยาคล้ายกัน">ชื่อยาคล้ายกัน</option>
                            <option value="ชื่อยาออกเสียงคล้ายกัน">ชื่อยาออกเสียงคล้ายกัน</option>
                            <option value="กล่องยา packaging คล้ายกัน">กล่องยา packaging คล้ายกัน</option>
                            <option value="ยาหลายความแรง/ขนาด">ยาหลายความแรง/ขนาด</option>
                            <option value="เก็บยาใกล้กัน">เก็บยาใกล้กัน</option>
                            <option value="ลายมืออ่านยาก/ไม่ชัดเจน">ลายมืออ่านยาก/ไม่ชัดเจน</option>
                            <option value="สื่อสารผิดพลาด">สื่อสารผิดพลาด</option>
                            <option value="ภาระงานมากเกินไป">ภาระงานมากเกินไป</option>
                            <option value="ขาดความรอบคอบ">ขาดความรอบคอบ</option>
                            <option value="เร่งรีบ">เร่งรีบ</option>
                            <option value="ไม่ได้ตรวจสอบซ้ำ">ไม่ได้ตรวจสอบซ้ำ</option>
                            <option value="เภสัช/เจ้าหน้าที่ขาด">เภสัช/เจ้าหน้าที่ขาด</option>
                            <option value="ห้องยาลง order ผิด">ห้องยาลง order ผิด</option>
                            <option value="ไม่ได้ตรวจสอบยาหมดอายุ">ไม่ได้ตรวจสอบยาหมดอายุ</option>
                            <option value="สาเหตุอื่นๆ">สาเหตุอื่นๆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="additionalDetails">รายละเอียดเพิ่มเติม (ถ้ามี):</label>
                        <textarea id="additionalDetails" name="additionalDetails" rows="4" placeholder="อธิบายรายละเอียดเพิ่มเติมของเหตุการณ์..."></textarea>
                    </div>

                    <!-- HAD Information Section -->
                    <div class="form-group had-section" style="display: none;">
                        <div class="had-alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="had-title">ตรวจพบ High Alert Drugs (HAD)</span>
                        </div>
                        <div class="had-details">
                            <div class="had-info">
                                <label>รายการ HAD ที่เกี่ยวข้อง:</label>
                                <div id="hadDrugsList" class="had-drugs-list"></div>
                            </div>
                            <div class="had-risk">
                                <label>ระดับความเสี่ยง:</label>
                                <span id="hadRiskLevel" class="risk-badge risk-high">สูง</span>
                            </div>
                        </div>
                        <!-- Hidden fields for HAD data -->
                        <input type="hidden" id="hadInvolved" name="hadInvolved" value="false">
                        <input type="hidden" id="hadDrugName" name="hadDrugName" value="">
                        <input type="hidden" id="hadRiskLevel" name="hadRiskLevel" value="Regular">
                    </div>

                    <div class="form-group">
                        <label for="reporter">ผู้รายงาน:</label>
                        <input type="text" id="reporter" name="reporter" readonly 
                               value="กรุณาเข้าสู่ระบบก่อนใช้งาน" 
                               style="background-color: #f5f5f5; cursor: not-allowed;">
                        <small>ข้อมูลจากผู้ใช้ที่เข้าสู่ระบบ</small>
                    </div>

                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> บันทึก
                    </button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
            <div class="card">
                <h2>แดชบอร์ดข้อผิดพลาด - การวิเคราะห์เชิงลึก</h2>
                <div class="user-info" id="dashboardUserInfo" style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px; border-left: 4px solid #2196f3;">
                    <strong>ผู้ใช้:</strong> <span id="currentUserDisplay">-</span> | 
                    <strong>กลุ่ม:</strong> <span id="currentGroupDisplay">-</span>
                </div>

                
                <!-- SECTION 1: ภาพรวมระบบ -->
                <h3 style="margin-top:10px;">ส่วนที่ 1: ภาพรวมระบบ</h3>
                <div class="stats-grid" id="overviewStats">
                    <div class="stat-card primary">
                        <div class="stat-icon"><i class="fas fa-database"></i></div>
                        <div class="stat-content">
                            <h3>ทั้งหมด (All Time)</h3>
                            <div class="stat-number" id="totalAllTime">0</div>
                            <div class="stat-description">รวมทุกช่วงเวลา</div>
                        </div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="stat-content">
                            <h3>เดือนนี้</h3>
                            <div class="stat-number" id="totalMonth">0</div>
                            <div class="stat-description">รวมในเดือนปัจจุบัน</div>
                        </div>
                    </div>
                    <div class="stat-card secondary">
                        <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                        <div class="stat-content">
                            <h3>7 วันล่าสุด</h3>
                            <div class="stat-number" id="totalWeek">0</div>
                            <div class="stat-description">ย้อนหลัง 7 วัน</div>
                        </div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                        <div class="stat-content">
                            <h3>วันนี้</h3>
                            <div class="stat-number" id="totalToday">0</div>
                            <div class="stat-description">ตั้งแต่ 00:00 น.</div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: รายบุคคล -->
                <h3 style="margin-top:30px;">ส่วนที่ 2: รายบุคคล (ผู้ใช้งาน)</h3>
                <div class="card" style="padding:15px; margin-bottom:25px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <strong>สรุปรายงานตามผู้รายงาน</strong>
                        <small>แสดงจำนวน (วันนี้ / 7 วัน / เดือนนี้ / ทั้งหมด)</small>
                    </div>
                    <!-- Current User Mini Stats -->
                    <div id="userMiniStats" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:12px;">
                        <div class="stat-card" style="flex:1 1 150px; min-width:140px; padding:10px 12px;">
                            <div class="stat-content" style="padding:0;">
                                <h4 style="font-size:14px; margin:0 0 4px;">วันนี้</h4>
                                <div class="stat-number" id="userToday" style="font-size:20px;">0</div>
                            </div>
                        </div>
                        <div class="stat-card" style="flex:1 1 150px; min-width:140px; padding:10px 12px;">
                            <div class="stat-content" style="padding:0;">
                                <h4 style="font-size:14px; margin:0 0 4px;">7 วัน</h4>
                                <div class="stat-number" id="userWeek" style="font-size:20px;">0</div>
                            </div>
                        </div>
                        <div class="stat-card" style="flex:1 1 150px; min-width:140px; padding:10px 12px;">
                            <div class="stat-content" style="padding:0;">
                                <h4 style="font-size:14px; margin:0 0 4px;">เดือนนี้</h4>
                                <div class="stat-number" id="userMonth" style="font-size:20px;">0</div>
                            </div>
                        </div>
                        <div class="stat-card" style="flex:1 1 150px; min-width:140px; padding:10px 12px;">
                            <div class="stat-content" style="padding:0;">
                                <h4 style="font-size:14px; margin:0 0 4px;">ทั้งหมด</h4>
                                <div class="stat-number" id="userAll" style="font-size:20px;">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- Per-user breakdown table (filteredให้เฉพาะผู้ใช้ปัจจุบัน) -->
                    <div style="margin-top:18px; overflow-x:auto;">
                        <table class="data-table" style="min-width:480px;">
                            <thead>
                                <tr>
                                    <th>ผู้รายงาน</th>
                                    <th>วันนี้</th>
                                    <th>7 วัน</th>
                                    <th>เดือนนี้</th>
                                    <th>ทั้งหมด</th>
                                </tr>
                            </thead>
                            <tbody id="userBreakdownBody">
                                <tr><td colspan="5" style="text-align:center;">กำลังโหลด...</td></tr>
                            </tbody>
                        </table>
                        <small style="display:block; margin-top:6px; color:#666;">หมายเหตุ: ตารางนี้แสดงเฉพาะข้อมูลของผู้ใช้ที่เข้าสู่ระบบ (สามารถขยายให้แสดงทุกคนได้ภายหลัง)</small>
                    </div>
                
                </div>

                <!-- SECTION 3: การวิเคราะห์เชิงลึก -->
                <h3 style="margin-top:10px;">ส่วนที่ 3: การวิเคราะห์เชิงลึก (ตามตัวกรอง)</h3>
                <!-- Analytics Filters -->
                <div id="analyticsFilters" style="display:flex; flex-wrap:wrap; gap:12px; margin:10px 0 20px; align-items:flex-end; background:#f9fafc; padding:12px; border:1px solid #e0e6ef; border-radius:8px;">
                    <div style="display:flex; flex-direction:column; min-width:160px;">
                        <label for="analyticsErrorType" style="font-size:12px; font-weight:600; color:#333;">ประเภทผู้ป่วย</label>
                        <select id="analyticsErrorType" style="padding:6px 8px;">
                            <option value="all">ทั้งหมด</option>
                            <option value="ผู้ป่วยนอก">ผู้ป่วยนอก</option>
                            <option value="ผู้ป่วยใน">ผู้ป่วยใน</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; min-width:140px;">
                        <label for="analyticsProcessFilter" style="font-size:12px; font-weight:600; color:#333;">กระบวนการ</label>
                        <select id="analyticsProcessFilter" style="padding:6px 8px;">
                            <option value="all">ทั้งหมด</option>
                            <option value="จัดยา">จัดยา</option>
                            <option value="ลงข้อมูล">ลงข้อมูล</option>
                            <option value="เตรียมยา">เตรียมยา</option>
                            <option value="คิดค่าใช้จ่าย">คิดค่าใช้จ่าย</option>
                            <option value="จัดเก็บ">จัดเก็บ</option>
                            <option value="จัดส่ง">จัดส่ง</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; min-width:140px;">
                        <label for="analyticsPeriodMode" style="font-size:12px; font-weight:600; color:#333;">โหมดช่วงเวลา</label>
                        <select id="analyticsPeriodMode" style="padding:6px 8px;">
                            <option value="all">ทั้งหมด</option>
                            <option value="year">ปี</option>
                            <option value="month">เดือน</option>
                        </select>
                    </div>
                    <div id="analyticsYearWrapper" style="display:none; flex-direction:column; min-width:120px;">
                        <label for="analyticsYear" style="font-size:12px; font-weight:600; color:#333;">ปี</label>
                        <select id="analyticsYear" style="padding:6px 8px;"></select>
                    </div>
                    <div id="analyticsMonthWrapper" style="display:none; flex-direction:column; min-width:140px;">
                        <label for="analyticsMonth" style="font-size:12px; font-weight:600; color:#333;">เดือน</label>
                        <select id="analyticsMonth" style="padding:6px 8px;">
                            <option value="01">มกราคม</option>
                            <option value="02">กุมภาพันธ์</option>
                            <option value="03">มีนาคม</option>
                            <option value="04">เมษายน</option>
                            <option value="05">พฤษภาคม</option>
                            <option value="06">มิถุนายน</option>
                            <option value="07">กรกฎาคม</option>
                            <option value="08">สิงหาคม</option>
                            <option value="09">กันยายน</option>
                            <option value="10">ตุลาคม</option>
                            <option value="11">พฤศจิกายน</option>
                            <option value="12">ธันวาคม</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:8px; align-items:flex-end;">
                        <button id="applyAnalyticsFilters" type="button" class="btn" style="background:#1976d2; color:#fff; padding:8px 14px; border-radius:6px; border:none; cursor:pointer;">
                            <i class="fas fa-filter"></i> ใช้ตัวกรอง
                        </button>
                        <button id="resetAnalyticsFilters" type="button" class="btn" style="background:#607d8b; color:#fff; padding:8px 14px; border-radius:6px; border:none; cursor:pointer;">
                            <i class="fas fa-undo"></i> รีเซ็ต
                        </button>
                    </div>
                    <div id="analyticsFilterSummary" style="font-size:12px; color:#555; flex:1; min-width:200px;">ตัวกรอง: ทั้งหมด</div>
                </div>

                <!-- Analytics Charts Section -->
                <div class="analytics-section">
                    <div class="section-header">
                        <h3><i class="fas fa-chart-bar"></i> การวิเคราะห์ข้อมูลเชิงลึก</h3>
                        <p>การวิเคราะห์รูปแบบและแนวโน้มของข้อผิดพลาดในการจ่ายยา</p>
                    </div>
                    
                    <div class="analytics-grid">
                        <!-- Error Details Analysis -->
                        <div class="analytics-card error-card" style="--card-index: 0;">
                            <div class="card-header">
                                <h4><i class="fas fa-exclamation-triangle"></i> ข้อผิดพลาด</h4>
                                <div class="card-actions">
                                    <select id="errorProcessFilter" onchange="filterErrorByProcess()" style="margin-right: 10px; padding: 5px 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="all">ทุกกระบวนการ</option>
                                        <option value="จัดยา">จัดยา</option>
                                        <option value="ลงข้อมูล">ลงข้อมูล</option>
                                        <option value="เตรียมยา">เตรียมยา</option>
                                        <option value="คิดค่าใช้จ่าย">คิดค่าใช้จ่าย</option>
                                        <option value="จัดเก็บ">จัดเก็บ</option>
                                        <option value="จัดส่ง">จัดส่ง</option>
                                    </select>
                                    <button onclick="refreshChart('error')" class="btn-icon" title="รีเฟรชกราฟ">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="errorChart" width="420" height="320"></canvas>
                            </div>
                            <div class="chart-summary">
                                <div class="summary-item">
                                    <span class="label">ข้อผิดพลาดหลัก:</span>
                                    <span class="value" id="topError">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">กระบวนการ:</span>
                                    <span class="value" id="selectedErrorProcess">ทุกกระบวนการ</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">จำนวนรายการ:</span>
                                    <span class="value" id="errorItemCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Cause Analysis -->
                        <div class="analytics-card cause-card" style="--card-index: 1;">
                            <div class="card-header">
                                <h4><i class="fas fa-search"></i> สาเหตุของข้อผิดพลาด</h4>
                                <div class="card-actions">
                                    <select id="processFilter" onchange="filterCauseByProcess()" style="margin-right: 10px; padding: 5px 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="all">ทุกกระบวนการ</option>
                                        <option value="จัดยา">จัดยา</option>
                                        <option value="ลงข้อมูล">ลงข้อมูล</option>
                                        <option value="เตรียมยา">เตรียมยา</option>
                                        <option value="คิดค่าใช้จ่าย">คิดค่าใช้จ่าย</option>
                                        <option value="จัดเก็บ">จัดเก็บ</option>
                                        <option value="จัดส่ง">จัดส่ง</option>
                                    </select>
                                    <button onclick="refreshChart('cause')" class="btn-icon" title="รีเฟรชกราฟ">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="causeChart" width="420" height="320"></canvas>
                            </div>
                            <div class="chart-summary">
                                <div class="summary-item">
                                    <span class="label">สาเหตุหลัก:</span>
                                    <span class="value" id="topCause">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">กระบวนการ:</span>
                                    <span class="value" id="selectedProcess">ทุกกระบวนการ</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">จำนวนรายการ:</span>
                                    <span class="value" id="causeItemCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Drug Statistics -->
                        <div class="analytics-card drug-card" style="--card-index: 2;">
                            <div class="card-header">
                                <h4><i class="fas fa-pills"></i> รายการยาที่ถูกต้อง</h4>
                                <div class="card-actions">
                                    <select id="drugProcessFilter" onchange="filterDrugByProcess()" style="margin-right: 10px; padding: 5px 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="all">ทุกกระบวนการ</option>
                                        <option value="จัดยา">จัดยา</option>
                                        <option value="ลงข้อมูล">ลงข้อมูล</option>
                                        <option value="เตรียมยา">เตรียมยา</option>
                                        <option value="คิดค่าใช้จ่าย">คิดค่าใช้จ่าย</option>
                                        <option value="จัดเก็บ">จัดเก็บ</option>
                                        <option value="จัดส่ง">จัดส่ง</option>
                                    </select>
                                    <button onclick="refreshChart('drug')" class="btn-icon" title="รีเฟรชกราฟ">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="drugChart" width="420" height="320"></canvas>
                            </div>
                            <div class="chart-summary">
                                <div class="summary-item">
                                    <span class="label">ยาหลัก:</span>
                                    <span class="value" id="topDrug">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">กระบวนการ:</span>
                                    <span class="value" id="selectedDrugProcess">ทุกกระบวนการ</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">จำนวนรายการ:</span>
                                    <span class="value" id="drugItemCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Process Analysis -->
                        <div class="analytics-card process-card" style="--card-index: 3;">
                            <div class="card-header">
                                <h4><i class="fas fa-cogs"></i> การกระจายตามกระบวนการ</h4>
                                <div class="card-actions">
                                    <button onclick="refreshChart('process')" class="btn-icon" title="รีเฟรชกราฟ">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="processChart" width="420" height="320"></canvas>
                            </div>
                            <div class="chart-summary">
                                <div class="summary-item">
                                    <span class="label">กระบวนการหลัก:</span>
                                    <span class="value" id="topProcess">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="label">จำนวน:</span>
                                    <span class="value" id="topProcessCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Time Analysis -->
                        <div class="analytics-card time-card" style="--card-index: 4;">
                            <div class="card-header">
                                <h4><i class="fas fa-clock"></i> การกระจายตามช่วงเวลา</h4>
                            </div>
                            <div class="time-distribution">
                                <div class="time-slot" style="--slot-index: 0;">
                                    <div class="time-header">
                                        <span class="time-label">เวรเช้า (08:00-16:00)</span>
                                        <span class="time-count" id="morningCount">0</span>
                                    </div>
                                    <div class="time-bar">
                                        <div class="time-fill morning" id="morningBar" style="width: 0%"></div>
                                    </div>
                                    <div class="time-percentage" id="morningPercent">0%</div>
                                </div>
                                <div class="time-slot" style="--slot-index: 1;">
                                    <div class="time-header">
                                        <span class="time-label">เวรบ่าย (16:00-24:00)</span>
                                        <span class="time-count" id="afternoonCount">0</span>
                                    </div>
                                    <div class="time-bar">
                                        <div class="time-fill afternoon" id="afternoonBar" style="width: 0%"></div>
                                    </div>
                                    <div class="time-percentage" id="afternoonPercent">0%</div>
                                </div>
                                <div class="time-slot" style="--slot-index: 2;">
                                    <div class="time-header">
                                        <span class="time-label">เวรดึก (24:00-08:00)</span>
                                        <span class="time-count" id="nightCount">0</span>
                                    </div>
                                    <div class="time-bar">
                                        <div class="time-fill night" id="nightBar" style="width: 0%"></div>
                                    </div>
                                    <div class="time-percentage" id="nightPercent">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Ranking -->
                        <div class="analytics-card location-card" style="--card-index: 5;">
                            <div class="card-header">
                                <h4><i class="fas fa-map-marker-alt"></i> สถานที่เกิดเหตุบ่อยที่สุด</h4>
                            </div>
                            <div class="location-ranking" id="locationRanking">
                                <div class="ranking-item">
                                    <div class="rank-badge">1</div>
                                    <div class="location-info">
                                        <div class="location-name">กำลังโหลด...</div>
                                        <div class="location-count">0 ครั้ง</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Trend -->
                        <div class="analytics-card full-width trend-card" style="--card-index: 6;">
                            <div class="card-header">
                                <h4><i class="fas fa-chart-line"></i> แนวโน้มรายเดือน (6 เดือนล่าสุด)</h4>
                                <div class="card-actions">
                                    <select id="trendPeriod" onchange="updateTrendChart()">
                                        <option value="6">6 เดือน</option>
                                        <option value="12">12 เดือน</option>
                                        <option value="24">24 เดือน</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-container large">
                                <canvas id="trendChart" width="800" height="300"></canvas>
                            </div>
                            <div class="trend-insights">
                                <div class="insight-item">
                                    <i class="fas fa-arrow-up text-danger"></i>
                                    <span>เดือนที่มีข้อผิดพลาดสูงสุด: <strong id="peakMonth">-</strong></span>
                                </div>
                                <div class="insight-item">
                                    <i class="fas fa-arrow-down text-success"></i>
                                    <span>เดือนที่มีข้อผิดพลาดต่ำสุด: <strong id="lowMonth">-</strong></span>
                                </div>
                                <div class="insight-item">
                                    <i class="fas fa-percentage text-info"></i>
                                    <span>อัตราการเปลี่ยนแปลง: <strong id="changeRate">-</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Data Table -->
                <div class="data-table-section">
                    <div class="section-header">
                        <h3><i class="fas fa-table"></i> ตารางข้อมูลรายละเอียด</h3>
                        <div class="table-controls">
                            <input type="text" id="tableSearch" placeholder="ค้นหาในตาราง..." class="search-input">
                            <select id="tablePageSize" class="page-size-select">
                                <option value="25">25 รายการ</option>
                                <option value="50">50 รายการ</option>
                                <option value="100">100 รายการ</option>
                            </select>
                            <button onclick="exportTableData()" class="export-table-btn">
                                <i class="fas fa-file-excel"></i> ส่งออกตาราง
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-legend">
                            <span class="legend-item">
                                <span class="legend-color my-report"></span>
                                รายงานของคุณ
                            </span>
                            <span class="legend-item">
                                <span class="legend-color high-priority"></span>
                                ข้อผิดพลาดสำคัญ
                            </span>
                        </div>
                        <div class="table-wrapper">
                            <table id="errorTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="reportId">
                                            <span>เลขที่รายงาน</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="date">
                                            <span>วันที่</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="shift">
                                            <span>เวร</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="type">
                                            <span>ประเภท</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="location">
                                            <span>สถานที่</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="process">
                                            <span>กระบวนการ</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="error">
                                            <span>ข้อผิดพลาด</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th class="sortable" data-sort="reporter">
                                            <span>ผู้รายงาน</span>
                                            <i class="fas fa-sort"></i>
                                        </th>
                                        <th>การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody id="errorTableBody">
                                    <tr>
                                        <td colspan="9" class="no-data">
                                            <div class="no-data-content">
                                                <i class="fas fa-database"></i>
                                                <p>ไม่มีข้อมูล</p>
                                                <small>กดปุ่ม "รีเฟรชข้อมูล" เพื่อโหลดจาก Google Sheets</small>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="table-pagination">
                            <div class="pagination-info">
                                แสดง <span id="showingStart">0</span> - <span id="showingEnd">0</span> 
                                จาก <span id="totalRecords">0</span> รายการ
                            </div>
                            <div class="pagination-controls">
                                <button id="prevPage" class="pagination-btn" disabled>
                                    <i class="fas fa-chevron-left"></i> ก่อนหน้า
                                </button>
                                <div id="pageNumbers" class="page-numbers">
                                    <span class="page-number active">1</span>
                                </div>
                                <button id="nextPage" class="pagination-btn" disabled>
                                    ถัดไป <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Drug List Section -->
        <section id="druglist" class="section">
            <div class="card">
                <div class="section-header">
                    <h2><i class="fas fa-pills"></i> รายการยา</h2>
                    <button id="addDrugBtn" class="btn btn-primary" onclick="showAddDrugForm()">
                        <i class="fas fa-plus"></i> เพิ่มยา
                    </button>
                </div>

                <!-- Add Drug Form -->
                <div id="addDrugForm" class="card" style="display: none; margin-bottom: 20px;">
                    <h3>เพิ่มรายการยาใหม่</h3>
                    <form id="drugForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="drugCode">รหัสยา (Drug Code):</label>
                                <input type="text" id="drugCode" name="drugCode" placeholder="เช่น D001, MED001" required>
                            </div>
                            <div class="form-group">
                                <label for="drugName">ชื่อยา (Drug Name):</label>
                                <input type="text" id="drugName" name="drugName" placeholder="ชื่อยาภาษาไทยและอังกฤษ" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="drugGroup">กลุ่มยา (Group):</label>
                                <select id="drugGroup" name="drugGroup" required>
                                    <option value="">-- เลือกกลุ่มยา --</option>
                                    <option value="Antibiotic">ยาปฏิชีวนะ (Antibiotic)</option>
                                    <option value="Analgesic">ยาแก้ปวด (Analgesic)</option>
                                    <option value="Antihypertensive">ยาลดความดันโลหิต (Antihypertensive)</option>
                                    <option value="Antidiabetic">ยาเบาหวาน (Antidiabetic)</option>
                                    <option value="Vitamin">วิตามิน (Vitamin)</option>
                                    <option value="Supplement">อาหารเสริม (Supplement)</option>
                                    <option value="Cardiac">ยาหัวใจ (Cardiac)</option>
                                    <option value="Respiratory">ยาระบบหายใจ (Respiratory)</option>
                                    <option value="Gastrointestinal">ยาระบบทางเดินอาหาร (Gastrointestinal)</option>
                                    <option value="Neurological">ยาระบบประสาท (Neurological)</option>
                                    <option value="Other">อื่นๆ (Other)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hadStatus">สถานะ HAD:</label>
                                <select id="hadStatus" name="hadStatus" required>
                                    <option value="">-- เลือกสถานะ HAD --</option>
                                    <option value="High">High Alert Drug</option>
                                    <option value="Regular">ยาทั่วไป</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="drugStatus">สถานะการใช้งาน (Status):</label>
                            <select id="drugStatus" name="drugStatus" required>
                                <option value="">-- เลือกสถานะ --</option>
                                <option value="Active">ใช้งาน (Active)</option>
                                <option value="Inactive">ไม่ใช้งาน (Inactive)</option>
                                <option value="Discontinued">ยกเลิก (Discontinued)</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> บันทึกยา
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddDrugForm()">
                                <i class="fas fa-times"></i> ยกเลิก
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search and Filter -->
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="searchDrug" placeholder="ค้นหาจากรหัสยาหรือชื่อยา..." oninput="filterDrugs()">
                        </div>
                        <div class="form-group">
                            <select id="filterGroup" onchange="filterDrugs()">
                                <option value="">-- ทุกกลุ่มยา --</option>
                                <option value="Antibiotic">ยาปฏิชีวนะ</option>
                                <option value="Analgesic">ยาแก้ปวด</option>
                                <option value="Antihypertensive">ยาลดความดันโลหิต</option>
                                <option value="Antidiabetic">ยาเบาหวาน</option>
                                <option value="Vitamin">วิตามิน</option>
                                <option value="Supplement">อาหารเสริม</option>
                                <option value="Cardiac">ยาหัวใจ</option>
                                <option value="Respiratory">ยาระบบหายใจ</option>
                                <option value="Gastrointestinal">ยาระบบทางเดินอาหาร</option>
                                <option value="Neurological">ยาระบบประสาท</option>
                                <option value="Other">อื่นๆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="filterHAD" onchange="filterDrugs()">
                                <option value="">-- ทุกสถานะ HAD --</option>
                                <option value="High">High Alert Drug</option>
                                <option value="Regular">ยาทั่วไป</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Drug List Table -->
                <div class="table-container">
                    <table id="drugTable" class="data-table">
                        <thead>
                            <tr>
                                <th>รหัสยา</th>
                                <th>ชื่อยา</th>
                                <th>กลุ่มยา</th>
                                <th>HAD</th>
                                <th>สถานะ</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="drugTableBody">
                            <tr>
                                <td colspan="6" class="text-center">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Drug Statistics -->
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDrugs">0</div>
                        <div class="stat-label">รายการยาทั้งหมด</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="hadDrugs">0</div>
                        <div class="stat-label">High Alert Drug</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeDrugs">0</div>
                        <div class="stat-label">ยาที่ใช้งาน</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="inactiveDrugs">0</div>
                        <div class="stat-label">ยาที่ไม่ใช้งาน</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="card">
                <h2>ตั้งค่า Google Sheets</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="apiKey">Google Sheets API Key:</label>
                        <input type="password" id="apiKey" name="apiKey" value="" placeholder="ใส่ Google Sheets API key ของคุณ">
                        <small>รับ API key จาก Google Cloud Console</small>
                    </div>

                    <div class="form-group">
                        <label for="spreadsheetId">Spreadsheet ID:</label>
                        <input type="text" id="spreadsheetId" name="spreadsheetId" value="" placeholder="ใส่ Google Sheets ID">
                        <small>พบใน URL ของ Google Sheet ของคุณ</small>
                    </div>

                    <div class="form-group">
                        <label for="sheetName">ชื่อ Sheet ข้อผิดพลาด:</label>
                        <input type="text" id="sheetName" name="sheetName" value="Predispensing_Errors" placeholder="ชื่อ sheet สำหรับข้อผิดพลาด">
                    </div>

                    <div class="form-group">
                        <label for="userSheetName">ชื่อ Sheet ผู้ใช้:</label>
                        <input type="text" id="userSheetName" name="userSheetName" value="Users" placeholder="ชื่อ sheet สำหรับข้อมูลผู้ใช้">
                        <small>Sheet นี้ใช้สำหรับดึงรายชื่อผู้ใช้ในระบบ</small>
                    </div>

                    <div class="form-group">
                        <label for="drugSheetName">ชื่อ Sheet รายการยา:</label>
                        <input type="text" id="drugSheetName" name="drugSheetName" value="Drug_List" placeholder="ชื่อ sheet สำหรับรายการยา">
                        <small>Sheet นี้ใช้สำหรับดึงรายชื่อรายการยาในระบบ</small>
                    </div>

                    <div class="form-group">
                        <label for="webAppUrl">Google Apps Script Web App URL:</label>
                        <input type="url" id="webAppUrl" name="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <div class="cors-info" style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 0.9rem;">
                            <strong>⚠️ หมายเหตุ CORS:</strong><br>
                            • หากเกิด CORS error ให้ deploy Apps Script ใหม่<br>
                            • ตั้งค่า Execute as: "Me", Who has access: "Anyone"<br>
                            • หรือใช้ Google Chrome ด้วย --disable-web-security flag<br>
                            • หรือใช้ Live Server extension แทน file:// protocol
                        </div>
                        <small>จำเป็นสำหรับการบันทึกข้อมูล (ดูคำแนะนำด้านล่าง)</small>
                    </div>

                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> บันทึกการตั้งค่า
                    </button>
                </form>

                <div class="setup-instructions">
                    <h3>คำแนะนำการตั้งค่า:</h3>
                    <ol>
                        <li>สร้าง Google Sheet พร้อม 2 tabs:
                            <ul>
                                <li><strong>Predispensing_Errors</strong> พร้อมคอลัมน์: วันที่, เลขที่รายงาน, เวร, ประเภท, สถานที่, กระบวนการ, ข้อผิดพลาด, รายการถูกต้อง, รายการผิด, สาเหตุ, รายละเอียดเพิ่มเติม, ผู้รายงาน</li>
                                <li><strong>Users</strong> พร้อมคอลัมน์: PS Code, ID 13 หลัก, ชื่อ-นามสกุล, กลุ่ม, ระดับ, อีเมล, รหัสผ่าน, status</li>
                            </ul>
                        </li>
                        <li><strong>แชร์ Google Sheet:</strong> คลิก "แชร์" → เปลี่ยนเป็น "ทุกคนที่มีลิงก์สามารถดูได้"</li>
                        <li><strong>สร้าง Google Apps Script สำหรับบันทึกข้อมูล:</strong>
                            <ol type="a">
                                <li>ใน Google Sheet ไปที่ Extensions → Apps Script</li>
                                <li>ลบโค้ดเดิม และคัดลอกโค้ดด้านล่างใส่แทน</li>
                                <li>บันทึก → Deploy → New deployment</li>
                                <li>Type: Web app → Execute as: Me → Who has access: Anyone</li>
                                <li>คัดลอก Web app URL มาใส่ในช่องด้านบน</li>
                                <li><strong>หมายเหตุ:</strong> หากอัปเดตโค้ด Apps Script ต้อง Deploy ใหม่</li>
                            </ol>
                        </li>
                        <li>ไปที่ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                        <li><strong>เปิดใช้งาน Google Sheets API:</strong> APIs & Services → Library → ค้นหา "Google Sheets API" → เปิดใช้งาน</li>
                        <li><strong>สร้าง API Key:</strong> APIs & Services → Credentials → Create Credentials → API Key</li>
                        <li>คัดลอกข้อมูลผู้ใช้จากไฟล์ users.csv ไปใส่ใน Sheet Users</li>
                        <li><strong>ทดสอบ:</strong> คลิก "รีเฟรชรายชื่อผู้ใช้" เพื่อตรวจสอบการเชื่อมต่อ</li>
                    </ol>
                    
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #0066cc;">
                        <h4 style="color: #0066cc; margin-top: 0;">Google Apps Script Code:</h4>
                                                                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px;">// Minimal ตัวอย่าง (อัปเดต): Apps Script ไม่รองรับ setHeaders กับ ContentService
                        function jsonResponse(o){return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);} 
                        function doPost(e){
                            try{
                                let data;
                                if(e.parameter && e.parameter.action){ data = e.parameter; }
                                else if(e.postData && e.postData.contents){ data = JSON.parse(e.postData.contents); }
                                else { return jsonResponse({error:'No data'}); }
                                const ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
                                if(data.action==='append'){
                                    const sheet = ss.getSheetByName(data.sheetName || 'Predispensing_Errors');
                                    if(!sheet) return jsonResponse({error:'Sheet not found'});
                                    if(data.timestamp){
                                        sheet.appendRow([
                                            data.timestamp,
                                            data.reportId,
                                            data.shift,
                                            data.errorType,
                                            data.location,
                                            data.process,
                                            data.errorDetail,
                                            data.correctItem,
                                            data.incorrectItem,
                                            data.cause,
                                            data.additionalDetails||'',
                                            data.reporter
                                        ]);
                                        return jsonResponse({success:true});
                                    }
                                }
                                return jsonResponse({error:'Invalid action'});
                            }catch(err){return jsonResponse({error:err.toString()});}
                        }</pre>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-top: 0;">หมายเหตุสำคัญ:</h4>
                        <ul style="color: #856404; margin-bottom: 0;">
                            <li><strong>API Key</strong> ใช้สำหรับอ่านข้อมูลเท่านั้น (Users list)</li>
                            <li><strong>Web App URL</strong> จำเป็นสำหรับการบันทึกข้อมูล</li>
                            <li>หากไม่ตั้งค่า Web App จะไม่สามารถบันทึกข้อผิดพลาดได้</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </div> <!-- End mainApp -->

    <div id="notification" class="notification"></div>

    <script src="script.js"></script>
</body>
</html>
